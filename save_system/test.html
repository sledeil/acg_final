<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Save System Test</title>
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #000;
      color: #00ff00;
      font-family: 'Courier New', monospace;
    }
    h1 {
      text-align: center;
      text-shadow: 0 0 10px #00ff00;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: rgba(0, 50, 0, 0.3);
      padding: 20px;
      border: 2px solid #00ff00;
      border-radius: 10px;
    }
    button {
      background: #00ff00;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      font-family: 'Courier New', monospace;
    }
    button:hover {
      background: #00ffff;
    }
    button:active {
      transform: scale(0.95);
    }
    .output {
      background: #000;
      border: 1px solid #00ff00;
      padding: 15px;
      margin-top: 20px;
      border-radius: 5px;
      max-height: 400px;
      overflow-y: auto;
      font-size: 12px;
    }
    .success {
      color: #00ff00;
    }
    .error {
      color: #ff0000;
    }
    .info {
      color: #00ffff;
    }
    .test-section {
      margin: 20px 0;
      padding: 15px;
      border: 1px solid #00ff00;
      border-radius: 5px;
    }
    .test-section h3 {
      margin-top: 0;
      color: #ffff00;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸš€ Save System Test Console</h1>
    
    <div class="test-section">
      <h3>1. Basic Operations</h3>
      <button onclick="testSave()">Save Game</button>
      <button onclick="testLoad()">Load Game</button>
      <button onclick="testDelete()">Delete Save</button>
      <button onclick="listSaves()">List All Saves</button>
    </div>

    <div class="test-section">
      <h3>2. Advanced Features</h3>
      <button onclick="testMultipleSlots()">Test Multiple Slots</button>
      <button onclick="testSerialization()">Test Serialization</button>
      <button onclick="testExport()">Export Save</button>
      <button onclick="testClearAll()">Clear All (âš ï¸ Dangerous)</button>
    </div>

    <div class="test-section">
      <h3>3. Run All Tests</h3>
      <button onclick="runAllTests()" style="background: #ffaa00; font-size: 16px; padding: 15px 30px;">â–¶ Run Full Test Suite</button>
    </div>

    <div class="test-section">
      <h3>ğŸ“Š Output</h3>
      <div id="output" class="output">
        <div class="info">Ready to test. Click a button above to start.</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { runAllDemos } from './demo.js';
    import { SaveManager } from './SaveManager.js';

    const output = document.getElementById('output');

    function log(message, type = 'info') {
      const div = document.createElement('div');
      div.className = type;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      output.appendChild(div);
      output.scrollTop = output.scrollHeight;
    }

    function clear() {
      output.innerHTML = '';
    }

    // Make functions available globally
    window.testSave = async function() {
      clear();
      log('Testing save operation...', 'info');
      
      try {
        const saveManager = SaveManager.getInstance();
        const gameState = {
          position: { x: 100, y: 200, z: 300 },
          velocity: { x: 1, y: 2, z: 3 },
          fuel: 75,
          score: 1234
        };

        await saveManager.saveToSlot(0, 'Test Save', gameState, {
          playerName: 'Test Player',
          gameTime: 567.89,
          currentLocation: 'Earth Orbit',
          fuelRemaining: 75,
          score: 1234
        });

        log('âœ… Save successful!', 'success');
      } catch (error) {
        log(`âŒ Save failed: ${error.message}`, 'error');
      }
    };

    window.testLoad = async function() {
      clear();
      log('Testing load operation...', 'info');
      
      try {
        const saveManager = SaveManager.getInstance();
        const saveGame = await saveManager.loadFromSlot(0);
        
        log('âœ… Load successful!', 'success');
        log(`Save name: ${saveGame.metadata.saveName}`, 'info');
        log(`Game time: ${saveGame.metadata.getFormattedGameTime()}`, 'info');
        log(`Saved: ${saveGame.metadata.getFormattedTimestamp()}`, 'info');
        log(`Game state: ${JSON.stringify(saveGame.gameState, null, 2)}`, 'info');
      } catch (error) {
        log(`âŒ Load failed: ${error.message}`, 'error');
      }
    };

    window.testDelete = async function() {
      clear();
      log('Testing delete operation...', 'info');
      
      if (!confirm('Delete save in slot 0?')) {
        log('Cancelled', 'info');
        return;
      }

      try {
        const saveManager = SaveManager.getInstance();
        await saveManager.deleteSaveSlot(0);
        log('âœ… Delete successful!', 'success');
      } catch (error) {
        log(`âŒ Delete failed: ${error.message}`, 'error');
      }
    };

    window.listSaves = async function() {
      clear();
      log('Listing all save slots...', 'info');
      
      try {
        const saveManager = SaveManager.getInstance();
        const saves = await saveManager.getAllSaveMetadata();
        
        let count = 0;
        saves.forEach((meta, slot) => {
          if (meta) {
            log(`Slot ${slot}: ${meta.saveName}`, 'success');
            log(`  Time: ${meta.getFormattedGameTime()} | Location: ${meta.currentLocation}`, 'info');
            log(`  Saved: ${meta.getFormattedTimestamp()}`, 'info');
            count++;
          } else {
            log(`Slot ${slot}: Empty`, 'info');
          }
        });

        log(`\nTotal saves: ${count}/${saves.length}`, 'success');
      } catch (error) {
        log(`âŒ Failed to list saves: ${error.message}`, 'error');
      }
    };

    window.testMultipleSlots = async function() {
      clear();
      log('Testing multiple save slots...', 'info');
      
      try {
        const saveManager = SaveManager.getInstance();

        for (let i = 0; i < 3; i++) {
          const gameState = { level: i + 1, data: `Test ${i}` };
          await saveManager.saveToSlot(i, `Save ${i + 1}`, gameState, {
            gameTime: i * 100,
            score: i * 1000
          });
          log(`Saved to slot ${i}`, 'success');
        }

        log('\nListing all saves:', 'info');
        const saves = await saveManager.getAllSaveMetadata();
        saves.forEach((meta, slot) => {
          if (meta) {
            log(`  Slot ${slot}: ${meta.saveName}`, 'success');
          }
        });

        log('\nâœ… Multiple slots test passed!', 'success');
      } catch (error) {
        log(`âŒ Test failed: ${error.message}`, 'error');
      }
    };

    window.testSerialization = function() {
      clear();
      log('Testing serialization utilities...', 'info');
      
      import('./JsonSerializer.js').then(({ JsonSerializer }) => {
        // Mock Vector3
        const vector = { x: 123.456789, y: 234.567890, z: 345.678901 };
        
        log('Original vector:', 'info');
        log(JSON.stringify(vector, null, 2), 'info');

        const serialized = JsonSerializer.serializeVector3(vector);
        log('\nSerialized:', 'info');
        log(JSON.stringify(serialized, null, 2), 'info');

        const deserialized = JsonSerializer.deserializeVector3(serialized);
        log('\nDeserialized:', 'info');
        log(JSON.stringify(deserialized, null, 2), 'info');

        // Test compression
        const compressed = JsonSerializer.compressFloatingPoint(vector, 2);
        log('\nCompressed (2 decimals):', 'info');
        log(JSON.stringify(compressed, null, 2), 'info');

        log('\nâœ… Serialization test passed!', 'success');
      });
    };

    window.testExport = async function() {
      clear();
      log('Exporting save file...', 'info');
      
      try {
        const saveManager = SaveManager.getInstance();
        
        // First ensure there's a save in slot 0
        const hasSave = await saveManager.hasSaveInSlot(0);
        if (!hasSave) {
          log('No save in slot 0, creating one first...', 'info');
          await saveManager.saveToSlot(0, 'Export Test', { test: true });
        }

        await saveManager.exportSaveToFile(0);
        log('âœ… Export initiated! Check your downloads.', 'success');
      } catch (error) {
        log(`âŒ Export failed: ${error.message}`, 'error');
      }
    };

    window.testClearAll = async function() {
      clear();
      log('âš ï¸ WARNING: This will delete ALL saves!', 'error');
      
      if (!confirm('Are you SURE you want to delete all saves?')) {
        log('Cancelled', 'info');
        return;
      }

      try {
        const saveManager = SaveManager.getInstance();
        await saveManager.clearAllSaves();
        log('âœ… All saves cleared!', 'success');
      } catch (error) {
        log(`âŒ Clear failed: ${error.message}`, 'error');
      }
    };

    window.runAllTests = async function() {
      clear();
      log('ğŸš€ Running full test suite...', 'info');
      log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
      
      try {
        // Redirect console to output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = (...args) => {
          log(args.join(' '), 'success');
          originalLog(...args);
        };

        console.error = (...args) => {
          log(args.join(' '), 'error');
          originalError(...args);
        };

        console.warn = (...args) => {
          log(args.join(' '), 'error');
          originalWarn(...args);
        };

        await runAllDemos();

        // Restore console
        console.log = originalLog;
        console.error = originalError;
        console.warn = originalWarn;

        log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•', 'info');
        log('âœ… All tests completed!', 'success');
      } catch (error) {
        log(`âŒ Test suite failed: ${error.message}`, 'error');
      }
    };

    // Initial message
    log('Save System Test Console ready!', 'success');
    log('Storage backend: ' + SaveManager.getInstance().storageBackend, 'info');
    log('Click a button above to start testing.', 'info');
  </script>
</body>
</html>
